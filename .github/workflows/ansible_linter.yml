---
# We need branch protection rule for all below to have purpose
env:
  SLACK_CHANNEL: "test_messages"

concurrency:
  group: ${{ github.workflow }}

name: "ansible-lint"
on:
  workflow_call:
    secrets:
      SLACK_TOKEN:
        description: 'A token passed from the caller workflow'
        required: true

jobs:

  run_ansible_lint:
    name: "Run ansible-lint"
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.pull_request.title, '[skip ansible-lint]')}}
    steps:

      - name: "Checkout source branch"
        id: checkout-scm
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "SHOW"
        run: echo "${{ github.head_ref }}"

      # - name: "Run ansible-lint"
      #   id: run-lint
      #   uses: ansible/ansible-lint@main
      #   with:
      #     args: " >> temp.txt"
      #     requirements_file: ""

      # - name: "Update python packages"
      #   run: |
      #     # pip install -r requirements_stable.txt
      #     pip install -U ansible-lint

      # # - name: "Update ansible collections"
      # #   run: ansible-galaxy collection install -r ansible_required_collections.yml

      # - name: "Run ansible-lint"
      #   id: run-lint
      #   run: ansible-lint > lint_tmp.txt

      # - name: "Prettify ansible-lint output"
      #   id: prettify-res
      #   if: failure()
      #   run: |
      #     if [ -s lint_tmp.txt ]; then
      #       characters_limit=1990
      #       cat lint_tmp.txt | head -c 1990 | sed -e '$a\' | sed 's/"/'\''/g'
      #       number_non_empty_lines=$(cat lint_tmp.txt | head -c $characters_limit | awk 'NF' | wc -l)
      #       current_limit=$((characters_limit - number_non_empty_lines))
      #       echo $current_limit
      #       echo "d"
      #       echo "GITDIFF<<EOF" >> $GITHUB_OUTPUT
      #       # echo -n '```' >> $GITHUB_OUTPUT
      #       cat lint_tmp.txt | head -c 1980 | sed -e '$a\' | sed 's/"/'\''/g' >> $GITHUB_OUTPUT
      #       # [ $(wc -c < lint_tmp.txt) -gt $current_limit ] && echo '...```' >> $GITHUB_OUTPUT || echo '```' >> $GITHUB_OUTPUT
      #       echo "EOF" >> $GITHUB_OUTPUT
      #       cat $GITHUB_OUTPUT
      #     fi

      # Add SLACK_API_TOKEN in dGithub secretsd
      - name: "Send Slack notifidcdation (fail)"
        id: send-fail-message
        #if: failure()
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_TOKEN }}
          payload: |
            channel: ${{ env.SLACK_CHANNEL }}
            text: ":github-action:"
            attachments:
              - color: "FF0000"
                fields:
                  - value: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Action log>"
                  - title: "Message"
                    short: false
                    value: "```yaml[document-start]: Missing document start '---'
                            1 copy 2.yml:1

                            yaml[empty-lines]: Too many blank lines (30 > 2)
                            1 copy 2.yml:44

                            yaml[empty-lines]: Too many blank lines (23 > 2)
                            1 copy 2.yml:68

                            yaml[empty-lines]: Too many blank lines (20 > 2)
                            1 copy 2.yml:89

                            yaml[empty-lines]: Too many blank lines (20 > 2)
                            1 copy 2.yml:110

                            yaml[empty-lines]: Too many blank lines (24 > 2)
                            1 copy 2.yml:135

                            yaml[empty-lines]: Too many blank lines (22 > 2)
                            1 copy 2.yml:158

                            yaml[empty-lines]: Too many blank lines (21 > 2)
                            1 copy 2.yml:180

                            yaml[empty-lines]: Too many blank lines (23 > 2)
                            1 copy 2.yml:204

                            yaml[empty-lines]: Too many blank lines (19 > 2)
                            1 copy 2.yml:224

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:228

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:232

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:236

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:240

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:244

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:248

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:252

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:256

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:260

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:264

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:268

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:272

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:276

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:280

                            yaml[empty-lines]: Too many blank lines (3 > 2)
                            1 copy 2.yml:284

                            yaml[empty-lines]: Too many blank lines (4 > 2)
                            1 copy 2.yml:289

                            yaml[new-line-at-end-of-file]: No new line character at the end of file
                            1 copy 2.yml:294

                            yaml[document-start]: Missing document start '---'
                            1 copy 3.yml:1

                            yaml[empty-lines]: Too many blank lines (30 1 2)
                            1 copy 3.ym ...```"


      # - name: "Close pull request if tests failed"
      #   id: close-failed-prd
      #   if: failure()
      #   uses: actions/github-script@v6
      #   with:sss
      #     script: |
      #         await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: ${{ github.event.number }},
      #         body: "Pull Request has been closed because it didn't pass [ansible-lint](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) tests"
      #         });
      #         await github.rest.pulls.update({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         pull_number: ${{ github.event.number }},
      #         state: "closed"
      #         });
